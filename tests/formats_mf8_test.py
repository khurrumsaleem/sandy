# -*- coding: utf-8 -*-
"""
Created on Tue Mar 05 15:59:46 2019

@author: Luca Fiorito
"""

__author__ = "Luca Fiorito"

import pytest
import os

import pandas as pd
import numpy as np

import sandy

@pytest.fixture(scope="module")
def No260():
    """MF8/MT457 from JEFF-3.3 No-260.
    """
    text = """ 1.022600+5 2.578680+2          0          0          0          03756 8457    1
 1.060000-1 8.000000-3          0          0          6          03756 8457    2
 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+03756 8457    3
 0.000000+0 1.000000+0          0          0          6          13756 8457    4
 6.000000+0 0.000000+0 0.000000+0 0.000000+0 1.000000+0 0.000000+03756 8457    5"""
    return text

@pytest.fixture(scope="module")
def Co60():
    """MF8/MT457 from JEFF-3.3 Co-60.
    """
    text = """ 2.706000+4 5.941900+1          0          0          0          4 562 8457    1
 1.663400+8 2.524550+4          0          0          6          0 562 8457    2
 9.652200+4 2.025290+2 2.503840+6 3.521860+2 0.000000+0 0.000000+0 562 8457    3
 5.000000+0 1.000000+0          0          0          6          1 562 8457    4
 1.000000+0 0.000000+0 2.823070+6 2.100000+2 1.000000+0 0.000000+0 562 8457    5
 0.000000+0 0.000000+0          0          0          6          6 562 8457    6
 1.000000-2 0.000000+0 2.503840+6 3.521860+2 0.000000+0 0.000000+0 562 8457    7
 3.471400+5 7.000000+1          0          0         12          0 562 8457    8
 1.000000+0 0.000000+0 7.500000-3 4.000000-4 0.000000+0 0.000000+0 562 8457    9
 5.570000-3 1.700000-4 4.990000-3 2.119200-4 5.030000-4 2.127690-5 562 8457   10
 8.261000+5 3.000000+1          0          0         12          0 562 8457   11
 1.000000+0 0.000000+0 7.600000-3 8.000000-4 0.000000+0 0.000000+0 562 8457   12
 3.400000-4 4.000000-5 3.000000-4 4.100000-5 2.910000-5 1.911050-6 562 8457   13
 1.173230+6 3.000000+0          0          0         12          0 562 8457   14
 1.000000+0 0.000000+0 9.985000+1 3.000000-2 0.000000+0 0.000000+0 562 8457   15
 1.680000-4 4.000000-6 1.510000-4 9.489040-6 1.480000-5 7.444940-7 562 8457   16
 1.332490+6 4.000000+0          0          0         12          0 562 8457   17
 1.000000+0 0.000000+0 9.998260+1 6.000000-4 0.000000+0 0.000000+0 562 8457   18
 1.280000-4 5.000000-6 1.150000-4 6.986060-6 1.130000-5 5.655460-7 562 8457   19
 2.158570+6 3.000000+1          0          0         12          0 562 8457   20
 1.000000+0 0.000000+0 1.200000-3 2.000000-4 0.000000+0 0.000000+0 562 8457   21
 4.950000-5 1.500000-6 4.450000-5 1.934480-6 4.300000-6 2.379940-7 562 8457   22
 2.505690+6 5.000000+0          0          0         12          0 562 8457   23
 1.000000+0 0.000000+0 2.000000-6 4.000000-7 0.000000+0 0.000000+0 562 8457   24
 8.600000-5 3.000000-6 7.800000-5 2.359150-6 7.600000-6 3.768080-7 562 8457   25
 0.000000+0 1.000000+0          0          0          6          3 562 8457   26
 1.000000-2 0.000000+0 9.616030+4 2.020130+2 0.000000+0 0.000000+0 562 8457   27
 3.173060+5 2.100270+2          0          0          6          0 562 8457   28
 1.000000+0 1.000000+0 9.988000+1 3.000000-2 0.000000+0 0.000000+0 562 8457   29
 6.644240+5 2.110370+2          0          0          6          0 562 8457   30
 1.000000+0 3.000000+0 2.000000-3 0.000000+0 0.000000+0 0.000000+0 562 8457   31
 1.490490+6 2.100270+2          0          0          6          0 562 8457   32
 1.000000+0 3.000000+0 1.200000-1 3.000000-2 0.000000+0 0.000000+0 562 8457   33
 0.000000+0 8.000000+0          0          0          6         14 562 8457   34
 1.000000-2 0.000000+0 3.617640+2 1.444640+1 0.000000+0 0.000000+0 562 8457   35
 8.400000+2 0.000000+0          0          0          6          0 562 8457   36
 1.000000+0 0.000000+0 3.919090-2 2.094640-3 0.000000+0 0.000000+0 562 8457   37
 6.540000+3 0.000000+0          0          0          6          0 562 8457   38
 1.000000+0 0.000000+0 1.559650-2 1.015470-3 0.000000+0 0.000000+0 562 8457   39
 3.388070+5 7.000110+1          0          0          6          0 562 8457   40
 1.000000+0 0.000000+0 3.742500-5 2.551510-6 0.000000+0 0.000000+0 562 8457   41
 3.461320+5 7.000110+1          0          0          6          0 562 8457   42
 1.000000+0 0.000000+0 3.772500-6 2.568000-7 0.000000+0 0.000000+0 562 8457   43
 8.177670+5 3.000270+1          0          0          6          0 562 8457   44
 1.000000+0 0.000000+0 2.280000-6 3.933120-7 0.000000+0 0.000000+0 562 8457   45
 8.250920+5 3.000270+1          0          0          6          0 562 8457   46
 1.000000+0 0.000000+0 2.211600-7 2.743910-8 0.000000+0 0.000000+0 562 8457   47
 1.164900+6 3.026550+0          0          0          6          0 562 8457   48
 1.000000+0 0.000000+0 1.507740-2 9.474910-4 0.000000+0 0.000000+0 562 8457   49
 1.172220+6 3.026550+0          0          0          6          0 562 8457   50
 1.000000+0 0.000000+0 1.477780-3 7.433910-5 0.000000+0 0.000000+0 562 8457   51
 1.324160+6 4.019950+0          0          0          6          0 562 8457   52
 1.000000+0 0.000000+0 1.149800-2 6.984840-4 0.000000+0 0.000000+0 562 8457   53
 1.331480+6 4.019950+0          0          0          6          0 562 8457   54
 1.000000+0 0.000000+0 1.129800-3 5.654470-5 0.000000+0 0.000000+0 562 8457   55
 2.150240+6 3.000270+1          0          0          6          0 562 8457   56
 1.000000+0 0.000000+0 5.340000-8 9.197760-9 0.000000+0 0.000000+0 562 8457   57
 2.157560+6 3.000270+1          0          0          6          0 562 8457   58
 1.000000+0 0.000000+0 5.160000-9 9.06180-10 0.000000+0 0.000000+0 562 8457   59
 2.497360+6 5.015970+0          0          0          6          0 562 8457   60
 1.000000+0 0.000000+0 1.56000-10 3.15548-11 0.000000+0 0.000000+0 562 8457   61
 2.504680+6 5.015970+0          0          0          6          0 562 8457   62
 1.000000+0 0.000000+0 1.52000-11 3.13202-12 0.000000+0 0.000000+0 562 8457   63
 0.000000+0 9.000000+0          0          0          6          4 562 8457   64
 1.000000-2 0.000000+0 8.349450-1 4.478700-2 0.000000+0 0.000000+0 562 8457   65
 8.500000+2 0.000000+0          0          0          6          0 562 8457   66
 1.000000+0 0.000000+0 1.494940-4 5.176260-5 0.000000+0 0.000000+0 562 8457   67
 7.460890+3 4.000000-2          0          0          6          0 562 8457   68
 1.000000+0 0.000000+0 3.270360-3 2.678440-4 0.000000+0 0.000000+0 562 8457   69
 7.478150+3 4.000000-2          0          0          6          0 562 8457   70
 1.000000+0 0.000000+0 6.437710-3 5.222590-4 0.000000+0 0.000000+0 562 8457   71
 8.260000+3 0.000000+0          0          0          6          0 562 8457   72
 1.000000+0 0.000000+0 1.310590-3 1.089730-4 0.000000+0 0.000000+0 562 8457   73"""
    return text

@pytest.fixture(scope="module")
def U234():
    """MF8/MT457 from JEFF-3.3 U-234. It was selected because it contains 
    both continuous and discrete spectra.
    """
    text = """ 9.223400+4 2.320300+2          0          0          0          63541 8457    1
 7.75370+12 9.467280+9          0          0          6          03541 8457    2
 1.414380+4 1.194650+3 1.450190+3 1.343010+2 4.841980+6 1.484590+33541 8457    3
 0.000000+0 1.000000+0          0          0         12          23541 8457    4
 4.000000+0 0.000000+0 4.857900+6 8.000000+2 1.000000+0 0.000000+03541 8457    5
 6.000000+0 0.000000+0 1.761000+8 3.310000+6 1.70000-11 1.00000-123541 8457    6
 0.000000+0 0.000000+0          2          0          6          63541 8457    7
 1.230000-3 0.000000+0 1.072340+2 1.226460+0 1.37428-10 1.59383-113541 8457    8
 5.320000+4 2.000000+1          0          0         12          03541 8457    9
 4.000000+0 0.000000+0 1.000000+0 1.626020-2 0.000000+0 0.000000+03541 8457   10
 2.330000+2 4.893000+0 0.000000+0 0.000000+0 1.700000+2 3.570000+03541 8457   11
 1.209000+5 2.000000+1          0          0         12          03541 8457   12
 4.000000+0 0.000000+0 2.780490-1 4.065040-3 0.000000+0 0.000000+03541 8457   13
 5.043000+0 1.008600-1 2.530000-1 5.060000-3 3.490000+0 6.980000-23541 8457   14
 4.549500+5 5.000000+1          0          0         12          03541 8457   15
 4.000000+0 0.000000+0 2.032520-4 4.065040-5 0.000000+0 0.000000+03541 8457   16
 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+03541 8457   17
 5.082000+5 1.000000+2          0          0         12          03541 8457   18
 4.000000+0 0.000000+0 1.219510-4 4.065040-5 0.000000+0 0.000000+03541 8457   19
 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+03541 8457   20
 5.817000+5 2.000000+2          0          0         12          03541 8457   21
 4.000000+0 0.000000+0 9.756100-5 4.065040-5 0.000000+0 0.000000+03541 8457   22
 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+03541 8457   23
 6.349000+5 2.000000+2          0          0         12          03541 8457   24
 4.000000+0 0.000000+0 2.439020-4 8.130080-5 0.000000+0 0.000000+03541 8457   25
 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+0 0.000000+03541 8457   26
 6.000000+0 0.000000+0          0          0          1         153541 8457   27
         15          2                                            3541 8457   28
 0.000000+0 0.000000+0 1.400000+5 9.165600-7 3.000000+5 8.862800-73541 8457   29
 5.000000+5 1.104630-6 7.000000+5 6.165900-7 1.000000+6 3.530300-73541 8457   30
 1.500000+6 1.528700-7 2.000000+6 8.133000-8 2.500000+6 5.967000-83541 8457   31
 3.000000+6 2.922000-8 4.000000+6 1.182000-8 5.000000+6 3.640000-93541 8457   32
 6.000000+6 2.120000-9 7.000000+6 1.40000-10 1.000000+7 0.000000+03541 8457   33
 0.000000+0 4.000000+0          0          0          6          53541 8457   34
 1.000000+0 0.000000+0 4.841980+6 1.484590+3 0.000000+0 0.000000+03541 8457   35
 4.150800+6 9.000000+2          0          0          6          03541 8457   36
 4.000000+0 0.000000+0 3.000000-7 1.000000-7 0.000000+0 0.000000+03541 8457   37
 4.275400+6 9.000000+2          0          0          6          03541 8457   38
 4.000000+0 0.000000+0 4.000000-7 1.000000-7 0.000000+0 0.000000+03541 8457   39
 4.603800+6 9.000000+2          0          0          6          03541 8457   40
 4.000000+0 0.000000+0 1.990000-3 2.000000-5 0.000000+0 0.000000+03541 8457   41
 4.722600+6 9.000000+2          0          0          6          03541 8457   42
 4.000000+0 0.000000+0 2.842000-1 2.000000-4 0.000000+0 0.000000+03541 8457   43
 4.774900+6 8.000000+2          0          0          6          03541 8457   44
 4.000000+0 0.000000+0 7.137000-1 2.000000-4 0.000000+0 0.000000+03541 8457   45
 0.000000+0 5.000000+0          1          0          6          03541 8457   46
 0.000000+0 0.000000+0 5.608300-5 6.684760-6 3.06000-11 3.55016-123541 8457   47
 6.000000+0 0.000000+0          0          0          1         383541 8457   48
         38          4                                            3541 8457   49
 1.221780-2 9.23550-11 1.221780-1 2.92052-10 1.221780+0 9.23550-103541 8457   50
 1.221780+1 2.920490-9 1.221780+2 9.234580-9 1.221780+3 2.917600-83541 8457   51
 2.443570+3 4.121990-8 3.665350+3 5.043340-8 4.887130+3 5.817730-83541 8457   52
 6.108910+3 6.497910-8 9.163370+3 7.938420-8 1.221780+4 9.143610-83541 8457   53
 1.832680+4 1.114270-7 3.665350+4 1.552360-7 6.108920+4 1.964410-73541 8457   54
 1.221780+5 2.642600-7 2.443570+5 3.381560-7 3.665350+5 3.747420-73541 8457   55
 4.887130+5 3.915370-7 6.108920+5 3.960940-7 7.330700+5 3.926080-73541 8457   56
 8.552490+5 3.837100-7 9.774270+5 3.711680-7 1.099610+6 3.562190-73541 8457   57
 1.221780+6 3.397550-7 1.527230+6 2.958340-7 1.832680+6 2.523860-73541 8457   58
 2.138120+6 2.123070-7 2.443570+6 1.767610-7 3.054460+6 1.198650-73541 8457   59
 3.665350+6 7.964110-8 4.887130+6 3.383080-8 6.108920+6 1.391470-83541 8457   60
 7.330700+6 5.607490-9 8.552490+6 2.228170-9 1.221780+7 1.32591-103541 8457   61
 1.832680+7 1.09418-12 2.443570+7 8.51306-15                      3541 8457   62
 0.000000+0 6.000000+0          0          0          6          03541 8457   63
 0.000000+0 0.000000+0 2.818600-3 1.755860-4 1.70000-11 1.00000-123541 8457   64
 0.000000+0 8.000000+0          0          0          6          83541 8457   65
 1.000000+0 0.000000+0 1.414380+4 1.414380+3 0.000000+0 0.000000+03541 8457   66
 4.176000+3 2.088000+2          0          0          6          03541 8457   67
 4.000000+0 0.000000+0 3.224940-1 3.224940-2 0.000000+0 0.000000+03541 8457   68
 9.478000+3 4.739000+2          0          0          6          03541 8457   69
 4.000000+0 0.000000+0 1.165410-1 1.165410-2 0.000000+0 0.000000+03541 8457   70
 1.124910+4 5.624550+2          0          0          6          03541 8457   71
 4.000000+0 0.000000+0 8.652600-5 8.652600-6 0.000000+0 0.000000+03541 8457   72
 3.689970+4 1.844980+3          0          0          6          03541 8457   73
 4.000000+0 0.000000+0 2.091000-1 2.091000-2 0.000000+0 0.000000+03541 8457   74
 4.902400+4 2.451200+3          0          0          6          03541 8457   75
 4.000000+0 0.000000+0 7.749000-2 7.749000-3 0.000000+0 0.000000+03541 8457   76
 7.912000+4 3.956000+3          0          0          6          03541 8457   77
 4.000000+0 0.000000+0 2.163150-6 2.163150-7 0.000000+0 0.000000+03541 8457   78
 1.046000+5 5.229990+3          0          0          6          03541 8457   79
 4.000000+0 0.000000+0 1.193580-3 1.193580-4 0.000000+0 0.000000+03541 8457   80
 1.167240+5 5.836200+3          0          0          6          03541 8457   81
 4.000000+0 0.000000+0 4.446000-4 4.446000-5 0.000000+0 0.000000+03541 8457   82
 0.000000+0 9.000000+0          0          0          6          73541 8457   83
 1.000000+0 0.000000+0 1.342960+3 1.342960+2 0.000000+0 0.000000+03541 8457   84
 4.176000+3 8.352000+1          0          0          6          03541 8457   85
 4.000000+0 0.000000+0 1.840870-2 1.840870-3 0.000000+0 0.000000+03541 8457   86
 1.340900+4 2.681800+2          0          0          6          03541 8457   87
 4.000000+0 0.000000+0 9.382160-2 9.382160-3 0.000000+0 0.000000+03541 8457   88
 8.995300+4 1.799060+3          0          0          6          03541 8457   89
 4.000000+0 0.000000+0 2.498280-5 2.498280-6 0.000000+0 0.000000+03541 8457   90
 9.335000+4 1.867000+3          0          0          6          03541 8457   91
 4.000000+0 0.000000+0 4.075500-5 4.075500-6 0.000000+0 0.000000+03541 8457   92
 1.048310+5 2.096620+3          0          0          6          03541 8457   93
 4.000000+0 0.000000+0 4.727580-6 4.727580-7 0.000000+0 0.000000+03541 8457   94
 1.056100+5 2.112200+3          0          0          6          03541 8457   95
 4.000000+0 0.000000+0 9.006860-6 9.006860-7 0.000000+0 0.000000+03541 8457   96
 1.086000+5 2.172000+3          0          0          6          03541 8457   97
 4.000000+0 0.000000+0 4.890600-6 4.890600-7 0.000000+0 0.000000+03541 8457   98"""
    return text
    
@pytest.mark.formats
@pytest.mark.endf6
@pytest.mark.mf8
@pytest.mark.rdd
def test_mf8_read_rdd_1(No260):
    """Test mf8 function _read_rdd for radioactive
    isotope (SF) without spectra info"""
    sec = sandy.formats.mf8._read_rdd(No260)
    assert sec["ZA"] == 1.022600E+5
    assert sec["AWR"] == 2.578680E+2
    assert sec["LIS"] == 0
    assert sec["LISO"] == 0
    assert sec["NST"] == 0
    assert sec["HL"] == 1.060000E-1
    assert sec["DHL"] == 8.000000E-3
    assert sec["E"] == [0]*3
    assert sec["DE"] == [0]*3
    assert sec["SPI"] == 0
    assert sec["PAR"] == 1
    assert len(sec["DK"]) == 1
    assert sec["DK"]["60"]["RFS"] == 0
    assert sec["DK"]["60"]["Q"] == 0
    assert sec["DK"]["60"]["DQ"] == 0
    assert sec["DK"]["60"]["BR"] == 1
    assert sec["DK"]["60"]["DBR"] == 0
    
@pytest.mark.formats
@pytest.mark.endf6
@pytest.mark.mf8
@pytest.mark.rdd
def test_mf8_read_rdd_2(U234):
    """Test mf8 function _read_rdd for radioactive
    isotope (SF) without spectra info
    Radiation spectra for:
    
        - 0 : gamma
        - 4 : alpha
        - 5 : neutrons
        - 6 : spontaneous fission
        - 8 : discrete electrons
        - 9 : X-rays and annihilation radiation
    """
    sec = sandy.formats.mf8._read_rdd(U234)
    assert sec["E"] == [14143.8, 1450.19, 4841980.0]
    assert sec["DE"] == [1194.65, 134.301, 1484.59]
    assert len(sec["DK"]) == 2
    assert sorted(sec["SPECTRA"].keys()) == [0, 4, 5, 6, 8, 9]
    assert sorted(sec["SPECTRA"][0]["ER"].keys()) == [53200.0, 120900.0, 454950.0, 508200.0, 581700.0, 634900.0]
    assert sec["SPECTRA"][0]["ER"][53200]['DER'] == 20.0
    assert sec["SPECTRA"][0]["ER"][53200]['RTYP'] == 4.0
    assert sec["SPECTRA"][0]["ER"][53200]['TYPE'] == 0.0
    assert sec["SPECTRA"][0]["ER"][53200]['RI'] == 1.0
    assert sec["SPECTRA"][0]["ER"][53200]['DRI'] == 0.0162602
    assert sec["SPECTRA"][0]["ER"][53200]['RIS'] == 0.0
    assert sec["SPECTRA"][0]["ER"][53200]['DRIS'] == 0.0
    assert sec["SPECTRA"][0]["ER"][53200]['RICC'] == 233.0
    assert sec["SPECTRA"][0]["ER"][53200]['DRICC'] == 4.893
    assert sec["SPECTRA"][0]["ER"][53200]['RICK'] == 0.0
    assert sec["SPECTRA"][0]["ER"][53200]['DRICK'] == 0.0
    assert sec["SPECTRA"][0]["ER"][53200]['RICL'] == 170.0
    assert sec["SPECTRA"][0]["ER"][53200]['DRICL'] == 3.57

@pytest.mark.formats
@pytest.mark.endf6
@pytest.mark.mf8
@pytest.mark.rdd
@pytest.mark.big
def test_mf8_read_rdd_jeff33():
    rdd = sandy.read_formatted_file(os.path.join("sandy", "data", "RDD", "RDD.jeff33"))
    for (mat,mf,mt),text in rdd.filter_by(listmt=[457]).TEXT.iteritems():
        rdd.read_section(mat,mf,mt)
